import os
import random
import time
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, filters

# ================== НАСТРОЙКИ ==================

BOT_TOKEN = os.getenv("BOT_TOKEN")  # или вставь строкой

START_TEXT = """================================
VV SYSTEM BOT
================================
Здравствуйте.
Я бот команды VV.
Если вы не знакомы с криптотерминами — это не проблема.
Информация представлена в упрощённом формате.

--------------------------------
ОСНОВНЫЕ ССЫЛКИ
--------------------------------
Основной канал: @Pipromems
Основной чат:   @liguemems
Hub 18+:        https://t.me/+jTET-PYrLekzMGMy
Чат $VSPACE:    https://t.me/+k7PHJiaLbLVhOGZi

================================
Добро пожаловать в экосистему VV.
================================
"""

# ================== ТРИГГЕРЫ ==================

COMPLEX_WORDS = [
    # технологии / база
    "api", "апи", "application", "апликейшн",
    "нода", "валидатор", "тестнет", "мейннет",
    "хешрейт", "хэш", "хэши",

    # pos / pow / dao / p2p
    "proof of stake", "proof of work", "pos", "pow",
    "dao", "дао",
    "p2p", "п2п",

    # defi / ликвидность
    "liquidity", "ликвидность", "ликвидити",
    "ликвид", "ликвидация", "ликвиднуло",
    "пул", "своп", "фарм", "фармить",
    "стейк", "стейкать", "стейкинг",
    "мост", "бридж", "бриджить",

    # рынок / трейдинг
    "памп", "пампить",
    "дамп", "дампить",
    "лонг", "лонговать",
    "шорт", "шортить", "шортил",
    "маржиналка", "плечо",
    "ордер", "стоп", "стоп-лосс",
    "тейк", "тейк-профит",
    "трейд", "трейдить",
    "скальпинг", "скальпить", "скальпировать",
    "сетка", "флэт", "боковик",
    "хай", "лоу",
    "отскок", "пролив", "перелив",
    "разворот", "вынос", "прострел",
    "перехай", "перелой",
    "просадка",

    # деривативы
    "спот", "фьючи", "фандинг",
    "лои", "открытый интерес",
    "экспирация", "перп",

    # свечи / ТА
    "волатильность",
    "свеча", "хвост", "сопля",
    "доджи", "пинбар",
    "поглощение", "ложняк",
    "пробой", "ретест",
    
    # hold / фиксация
    "холд", "холдер", "холдить",
    "фикс", "зафиксить",
    "усреднение","откуп", "откупать", "подбор", "добор",
    "слив",

    # настроение рынка
    "фомо", "фад", "паникселл",
    "бычка", "медвежка",
    "бык", "медведь",
    "беариш",
    "капитуляция",

    # альты / капа
    "альта", "альты", "альтсезон",
    "биток", "эфир",
    "комса",
    "капа", "доминирование",

    # nft
    "nft", "нфтшка",
    "минт","флип", "флипать",
    "снайп", "снайпер",
    "флор", "флорный",

    # токеномика
    "токеномика",
    "эмиссия",
    "сжигание", "бёрн",
    "инфляция", "дефляция",
    "саплай", "циркул",
    "флоат",
    "аллтаймхай", "аллтаймлоу",

    # иксы
    "икс", "два икса", "десять иксов",

    # airdrop / rewards / refs
    "airdrop", "аирдроп", "дроп",
    "ревард", "реварды", "ревардники",
    "реф", "рефка", "реферал", "рефнули", "рефнутый",
    "клейм", "вайтлист",

    # скам / безопасность
    "скамиться", "скам-проект",
    "раг", "рагпул", "рагпук",
    "фишинг", "фейк",
    "сидка", "слив сидки",

    # манипуляции / игроки
    "манипул", "манипуля",
    "маркетмейкер",
    "киты",
    "ритейл", "ретейл",
    "смартмани",
    "объёмы", "влив", "вылив",

    # мемы / сленг
    "деген", "дегенить", "дегенада",
    "лудка", "лудик", "лудоман", "гембла",
    "хомяк",
    "шиток", "щиткоин",
    "гем",
    "ракета", "полёт",
    "туземун",
    "котлета", "на всю котлету",
    "деп", "депнуть",
    "качели",
    "засадить", "засадка",
    "стряхнули",
    "вынесли",

    # инфо / хайп
    "анонс", "анонсить",
    "апка", "аппка", "миниаппа",
    "апдейт", "патч", "релиз",
    "дорожная карта",
    "тимка", "анонимы",
    "паблик", "закрытый чат",
    "инсайд",
    "инфл", "инфлы", "инфлов", "инфла",
    "наратив", "нарратив",
    "мета",
    "мемкоин",

    # otc / custody
    "otc",
    "кастодиал", "некастодиал",
    "ваучер", "инвайт", "гарант",

    # бритвы
    "брить", "бреют", "выбрить",
    "бритва", "побритый", "побрился",

    # гойский словарь
    "гой", "гои", "гойство"
]

RANDOM_PHRASES = [
    "Бро, ты слишком сложно объясняешь — о чём вообще речь?",
    "Я вообще не понял, можешь проще?",
    "Переведи с умного на человеческий.",
    "Честно — ноль понимания.",
    "Можно для чайников?",
    "Я потерялся, повтори попроще.",
    "Это сейчас на каком языке было?",
    "Ты меня потерял уже на середине сообщения.",
    "Я не улавливаю мысль, поясни.",
    "Слишком завуалировано, скажи прямо.",
    "Ты о чём конкретно?",
    "Много слов, а смысл где?",
    "Я не понял, к чему ты ведёшь.",
    "Можно для чайников?",
    "Звучит красиво, но непонятно."
]

# ================== СЛУЖЕБНОЕ ==================

last_reply_time = {}

def normalize_word(word: str) -> str:
    endings = [
        "ами", "ями", "ого", "ему", "ыми", "ими",
        "ить", "ать", "ять",
        "а", "я", "ы", "и", "е", "о", "у",
        "ов", "ев", "ей",
        "ый", "ий", "ая", "ое", "ее"
    ]

    for e in endings:
        if word.endswith(e) and len(word) > len(e) + 2:
            return word[:-len(e)]

    return word

def is_similar(a: str, b: str) -> bool:
    if abs(len(a) - len(b)) > 1:
        return False

    mismatches = 0
    i = j = 0

    while i < len(a) and j < len(b):
        if a[i] == b[j]:
            i += 1
            j += 1
        else:
            mismatches += 1
            if mismatches > 1:
                return False
            i += 1
            j += 1

    return True

# ================== ХЕНДЛЕРЫ ==================

async def start_command(update, context):
    if update.effective_chat.type == "private":
        await update.message.reply_text(START_TEXT)

async def handle_message(update, context):

    if not update.message or not update.message.text:
        return

    text = update.message.text.lower()
    chat = update.effective_chat

    # ===== пасхалки =====
    if "помидорас" in text:
        await update.message.reply_text("Сам ты помидорас")
        return

    if "соси" in text:
        await update.message.reply_text("а соси соси мне за 5$ не сделаешь?")
        return

    if "пупсик" in text:
        await update.message.reply_text("главный пупсик здесь я")
        return

    # ===== только группы =====
    if chat.type not in ["group", "supergroup"]:
        return

    # ===== поиск триггеров =====
    words = text.split()
    trigger_found = False

    for w in words:
        w_norm = normalize_word(w)
        if len(w_norm) < 5:
            continue

        for t in COMPLEX_WORDS:
            t_norm = normalize_word(t)
            if len(t_norm) < 5:
                continue

            if is_similar(w_norm, t_norm):
                trigger_found = True
                break

        if trigger_found:
            break

    if not trigger_found:
        return

    # ===== кулдаун =====
    now = time.time()
    cid = chat.id

    if cid in last_reply_time and now - last_reply_time[cid] < 60:
        return

    if random.random() > 0.7:
        return

    await update.message.reply_text(random.choice(RANDOM_PHRASES))
    last_reply_time[cid] = now

# ================== ЗАПУСК ==================

def main():
    if not BOT_TOKEN:
        raise RuntimeError("BOT_TOKEN не задан")

    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start_command))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("✅ Бот запущен")
    app.run_polling()

if __name__ == "__main__":
    main()















